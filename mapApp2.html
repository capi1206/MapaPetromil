<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
    body, html {
        margin: 0;
        padding: 0;
        height: 100%;
    }

    #map {
        width: 100%;
        height: 100vh;
    }
    </style>

</head>
<body>
    <div id="map" ></div>
    
    <script>
       var map = L.map('map', {
    center: [4.5709, -74.2973],
    zoom: 7,
});

//carga los datos del diccionario de establecimientos cercanos
var nearDic = {}; 
   

// capas de mapas Stadia
L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png', {
}).addTo(map);

$.getJSON('rutas2.geojson', function (data) {
    console.log(data);
    L.geoJSON(data, {
        style: function (feature) {
    
            var importance = feature.properties.vol;
            if (isNaN(importance)) {
                return {
                    color: 'white',
                    weight: 1,
                };
            }
            var fillColor = getColorFromVolume(importance);
            return {
                color: fillColor,
                weight: 1,
            };
        },
        onEachFeature: function (feature, layer) {
            if (feature.properties.nombreruta) {
                layer.bindPopup(feature.properties.nombreruta);
            }
        }
    }).addTo(map);
});

//a√±ade leyenda que explica los colores en las rutas
var legend = L.control({ position: 'bottomright' });

legend.onAdd = function (map) {
    var div = L.DomUtil.create('div', 'legend');
    var grades = [0, 0.2, 0.4, 0.6, 0.8, 1];
    var labels = [];
    for (var i = 0; i < grades.length - 1; i++) {
        var from = grades[i];
        var to = grades[i + 1];
        labels.push(
            '<i style="background:' +
                getColorFromVolume(from + 0.1) +
                '"></i> ' +
                from.toFixed(1) +
                (to ? '&ndash;' + to.toFixed(1) : '+')
        );
    }
    div.innerHTML +=
        '<br><span style="font-weight:bold;">Volumen de rutas:</span><br>' +
        '0.0 to 0.2: ' + '<span style="background: linear-gradient(90deg, rgba(0, 255, 0, 0.3), rgba(0, 255, 0, 1)); padding-left: 5px;">&nbsp;&nbsp;&nbsp;&nbsp;</span>' + '<br>' +
        '0.2 to 0.4: ' + '<span style="background: linear-gradient(90deg, rgba(255, 255, 0, 0.3), rgba(255, 255, 0, 1)); padding-left: 5px;">&nbsp;&nbsp;&nbsp;&nbsp;</span>' + '<br>' +
        '0.4 to 0.6: ' + '<span style="background: linear-gradient(90deg, rgba(255, 165, 0, 0.3), rgba(255, 165, 0, 1)); padding-left: 5px;">&nbsp;&nbsp;&nbsp;&nbsp;</span>' + '<br>' +
        '0.6 to 0.8:  ' + '<span style="background: linear-gradient(90deg, rgba(255, 0, 0, 0.3), rgba(255, 0, 0, 1)); padding-left: 5px;">&nbsp;&nbsp;&nbsp;&nbsp;</span>' + '<br>' +
        '0.8 to 1.0: ' + '<span style="background: linear-gradient(90deg, rgba(128, 0, 128, 0.3), rgba(128, 0, 128, 1)); padding-left: 5px;">&nbsp;&nbsp;&nbsp;&nbsp;</span>';
        div.style.width = '300px'; 
        div.style.fontSize = '20px'; 
        div.style.color = 'white'; 
    return div;
};

legend.addTo(map);

// genera el color apartir del volumen de las carreteras, calculado por volumenes de estaciones cercanas
function getColorFromVolume(volume) {
    var hue = (1- volume) * 120; // Adjust the 120 based on the range of colors required
    var color = 'hsl(' + hue + ', 100%, 50%)';
    return color;
}







Papa.parse('data/merged_eds.csv', {
                    download: true,
                    header: true,
                    complete: function (result) {
                        var stationData = result.data;
                        var validEntries = stationData.filter(entry => {
                                    var totalVenta = parseFloat(entry['Total Venta']);
                                    return !isNaN(totalVenta) && isFinite(totalVenta);
                                });
    //min-max vols in stations                            
    var minV = 42743612.0;
    var maxV = 2172345968.0;
    for (var i = 0; i < stationData.length; i++) {
            var station = stationData[i];
            var lat = parseFloat(station.LATITUD);
            var lon = parseFloat(station.LONGITUD);
            var tot= parseFloat(station['Total Venta']);

            var customIcon = L.icon({
                iconUrl: 'data/gas-pump.png', // Replace 'path/to/customIcon.png' with the path to your PNG image
                iconSize: [18, 18], // Adjust the size of the icon as needed
                iconAnchor: [10, 10], // Adjust the anchor of the icon if necessary
            });

            if (!isNaN(lat) && isFinite(lat) && !isNaN(lon) && isFinite(lon) && !isNaN(tot)) {
                var normalizedVenta = (tot - minV) / (maxV - minV);
                

            
            for (var k=0; k < 100;k++){
                L.circle([lat, lon], {
                                        radius: 300 +((k +1)/100)*normalizedVenta*10200,
                                        fillColor: 'white',
                                        fillOpacity: 0.1- k/100, // Adjust as needed for the faded outer annulus
                                        stroke: false // Remove the stroke for the outer annulus
                                    }).addTo(map);

            }  
            

            // Replace the circle creation with a custom marker using the icon
            var customMarker = L.marker([lat, lon], { icon: customIcon })
                .addTo(map)
                .bindPopup(station.n_eds);

            

    // Fit the map's view to display the circle
        

            // Use the custom marker for click interaction
            customMarker.on('click', function (e) {
                var clickedMarker = e.target; // Reference to the clicked marker
                var radiusCircle = L.circle(clickedMarker.getLatLng(), {
                radius: 1500, // Radius in meters // Circle color
                fillOpacity: 0, // Opacity of the filled circle
                stroke: false // Remove the stroke
            }).addTo(map);
                var name = clickedMarker.getPopup().getContent(); // Get the name from the popup content
                map.fitBounds(radiusCircle.getBounds());
                console.log(name);
                addNearFromJSON(name);
            });

        }
    }
    }
}); 
      
        
function getColorFromNormalizedValue(value) {
    var hue = 240; // Blue hues are around 240 degrees
    var lightness = 50 - value * 50; // Adjust lightness based on the value
    return 'hsl(' + hue + ', 100%, ' + lightness + '%)';
}




function addNearFromJSON(station) {
    $.getJSON('data/dic_near2.json', function (pointsData) {
        
            var aux =pointsData[station];
            aux.forEach(function (element) {
            var coords = element['lat-lon']; // Replace 'latitude' with the actual attribute name in your JSON data
            console.log(coords);
            // Create markers for each element and add them to the map
            L.marker(coords) // Use the coordinates directly as LatLng object
                .addTo(map)
                .bindPopup(element['nombre']); 
        });
    });
}



function addPointsFromJSON() {
    $.getJSON('data/dic_peajes_mapa.json', function (pointsData) {
                // Loop through the points in the JSON data
        Object.keys(pointsData).forEach(function (pointName) {
            var point = pointsData[pointName];
            var lat = point.lat; // Latitude from the point object
            var lon = point.lon; // Longitude from the point object

                    // Create a marker for each point and add it to the map
            L.marker([lat, lon])
                .addTo(map)
                .bindPopup(pointName); // Use the point name as the popup content
        });
    });
}

        // Call the function to add points from the JSON file to the map
addPointsFromJSON();



    </script>
</body>
</html>